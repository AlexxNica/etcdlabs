<md-sidenav-layout>
    <md-sidenav #sidenav [opened]="true" mode="side" class="doc-sidenav">
        <md-list dense>
            <a routerLink="/doc/{{docVersion}}">
                <h3 md-subheader>Getting Started ({{docVersion}})</h3>
            </a>
            <md-list-item *ngFor="let item of getStartedItems">
                <a routerLink="{{item.url}}" class="{{item.htmlClass}}">{{item.title}}</a>
            </md-list-item>

            <md-divider></md-divider>
            <h3 md-subheader>Operation Guides</h3>
            <md-list-item *ngFor="let item of operationItems">
                <a routerLink="{{item.url}}" class="{{item.htmlClass}}">{{item.title}}</a>
            </md-list-item>
        </md-list>
    </md-sidenav>

    <div class="doc-group">
        <router-outlet></router-outlet>

        <div id="top"></div>

        <h4>Manage etcd with Kubernetes</h4>
        <br>
        <p class="narrow-paragraph">
            Application container gives much portability to initial development phase. But operating and scaling container requires much more work. <a href="http://kubernetes.io/" target="_blank" class="normal-link">Kubernetes</a> manages such complex
            container environments. This is an example workflow to deploy etcd on Kubernetes, <b>in most manual way possible</b>. The goal is manage etcd using Kubernetes.
        </p>
        <p class="narrow-paragraph">
            See <a href="http://kubernetes.io/docs/getting-started-guides/minikube/" target="_blank" class="normal-link">Running Kubernetes Locally via Minikube</a> and other guides for more.
        </p>
        <ul>
            <li><a href="http://kubernetes.io/docs/getting-started-guides/" target="_blank" class="normal-link">Kubernetes Guides</a></li>
            <li><a href="https://coreos.com/kubernetes/docs/latest/kubernetes-on-baremetal.html" target="_blank" class="normal-link">Kubernetes Installation on Bare Metal & CoreOS</a></li>
            <li><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way" target="_blank" class="normal-link">Kubernetes The Hard Way</a></li>
            <li><a href="https://coreos.com/blog/introducing-operators.html" target="_blank" class="normal-link">Introducing Operators: Putting Operational Knowledge into Software</a></li>
            <li><a href="https://coreos.com/blog/introducing-the-etcd-operator.html" target="_blank" class="normal-link">Introducing the etcd Operator: Simplify etcd cluster configuration and management</a></li>
        </ul>

        <md-tab-group>

            <md-tab>
                <template md-tab-label>
					Prerequisite
				</template>
                <template md-tab-content>
					<br>

					<p class="narrow-paragraph">
                        For this exercise, we will use <a href="https://coreos.com" target="_blank" class="normal-link">CoreOS Linux</a> and <a href="https://github.com/coreos/rkt" target="_blank" class="normal-link">rkt</a> container runtime.
					</p>
					<p class="narrow-paragraph">
						And have following machines ready.
					</p>
					<ul>
						<li>3~5 for etcd cluster with TLS enabled; see <a routerLink="/doc/{{docVersion}}/install-deploy" class="normal-link">etcd Install and Deploy</a></li>
						<li>1 for <a href="http://kubernetes.io/docs/user-guide/kubectl-overview/" target="_blank" class="code-light-snippet">kubectl</a></li>
						<li>3 for master nodes with <a href="http://kubernetes.io/docs/admin/kubelet/" target="_blank" class="code-light-snippet">kubelet</a> and <a href="http://kubernetes.io/docs/admin/kube-apiserver/" target="_blank" class="code-light-snippet">kube-apiserver</a></li>
						<li>10 for workers with <a href="http://kubernetes.io/docs/admin/kubelet/" target="_blank" class="code-light-snippet">kubelet</a></li>
					</ul>

					<br>
					<p class="narrow-paragraph">
						First type etcd endpoints in <span class="code-light-snippet-red">scheme://host:port</span>
					</p>
					<!--TODO: use md-textarea-->
					<textarea
						type="text"
						style="max-width: 550px;"
						class="form-control"
						placeholder="etcd endpoints (line-separated)"
						rows="5"
						[(ngModel)]="kubeAPIServer.etcdServersTxt"
					></textarea>
					<br>
					<br>
					<p class="narrow-paragraph">
						Type etcd TLS certs for <a href="http://kubernetes.io/docs/admin/kube-apiserver/" target="_blank" class="code-light-snippet">kube-apiserver</a>
					</p>
					<md-input dividerColor="warn" type="text" [(ngModel)]="kubeAPIServer.etcdCAFile" placeholder="etcd trusted root CA"></md-input>
					<br>
					<md-input dividerColor="warn" type="text" [(ngModel)]="kubeAPIServer.etcdCertFile" placeholder="etcd cert (public)"></md-input>
					<br>
					<md-input dividerColor="warn" type="text" [(ngModel)]="kubeAPIServer.etcdKeyFile" placeholder="etcd key (private)"></md-input>
					<br>
					<br>
                    <md-input type="text" dividerColor="warn" [(ngModel)]="certsDir" placeholder="Kubernetes certs directory"></md-input>
					<br>
					<div class="osx-window">
						<div class="window-narrow">
							<div class="titlebar">
								<div class="buttons">
									<div class="closebtn"><span><strong></strong></span></div>
									<div class="minimize"><span><strong></strong></span></div>
									<div class="zoom"><span><strong></strong></span></div>
								</div><span class="title-bar-text">terminal</span></div>
							<div class="content">
								<pre class="osx-terminal-contents">{{cfssl.getCertsPrepareCommand(certsDir)}}</pre>
							</div>
						</div>
					</div>
					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>
					<br>

				</template>
            </md-tab>


            <md-tab>
                <template md-tab-label>
					TLS (cfssl)
				</template>
                <template md-tab-content>
					<br>
					<h5>Why?</h5>
					<p class="narrow-paragraph">
						If etcd and Kubernetes store information that should not be public, encryption is highly recommended. Kubernetes supports SSL/TLS for validating clients. Here's how to generate self-signed TLS certificates with
						<a href="https://github.com/cloudflare/cfssl" target="_blank" class="normal-link">cfssl</a>.
					</p>

					<br>
					<h5>Install cfssl</h5>
					<br>
					<md-input type="text" [(ngModel)]="cfssl.version" placeholder="cfssl version"></md-input>
					<md-input type="text" [(ngModel)]="cfssl.execDir" placeholder="exec dir"></md-input>
					<md-input type="text" [(ngModel)]="cfssl.srcCertsDir" placeholder="source certs dir"></md-input>
					<br>
					<div class="osx-window">
						<div class="window">
							<div class="titlebar">
								<div class="buttons">
									<div class="closebtn"><span><strong></strong></span></div>
									<div class="minimize"><span><strong></strong></span></div>
									<div class="zoom"><span><strong></strong></span></div>
								</div><span class="title-bar-text">terminal</span></div>
							<div class="content">
								<pre class="osx-terminal-contents">{{cfssl.getInstallCommand()}}</pre>
							</div>
						</div>
					</div>
					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>

					<br>
					<h5>Generate self-signed root CA certificate</h5>
					<p class="narrow-paragraph">
						We will use this root CA to generate unique TLS assets for validating API server, worker nodes, and others. Unique certificates are less convenient to generate and deploy, but they do provide stronger security assurances and the most portable installation experience across multiple cloud-based and on-premises Kubernetes deployments.
					</p>

					<br>
					<md-input type="text" [(ngModel)]="cfssl.organization" placeholder="Organization"></md-input>
					<md-input type="text" [(ngModel)]="cfssl.organizationUnit" placeholder="Organization Unit"></md-input>
					<md-input type="text" [(ngModel)]="cfssl.locationCity" placeholder="City"></md-input>
					<md-input type="text" [(ngModel)]="cfssl.locationState" placeholder="State"></md-input>
					<md-input type="text" [(ngModel)]="cfssl.locationCountry" placeholder="Country"></md-input>
					<br>
					<md-input type="text" [(ngModel)]="cfssl.keyAlgorithm" placeholder="Key Algorithm"></md-input>
					<md-input type="number" [(ngModel)]="cfssl.keySize" placeholder="Key Size"></md-input>
					<md-input type="number" [(ngModel)]="cfssl.keyExpirationHour" placeholder="Key Expiration (hour)"></md-input>
					<br>
					<md-input type="text" [(ngModel)]="cfssl.commonName" placeholder="Common Name"></md-input>
					<br>
					<br>

					<pre class="code-dark">{{cfssl.getRootCACommand()}}</pre>

					Results:
					<div class="osx-window">
						<div class="window-narrow">
							<div class="titlebar">
								<div class="buttons">
									<div class="closebtn"><span><strong></strong></span></div>
									<div class="minimize"><span><strong></strong></span></div>
									<div class="zoom"><span><strong></strong></span></div>
								</div><span class="title-bar-text">terminal</span></div>
							<div class="content">
								<pre class="osx-terminal-contents">{{cfssl.getRootCACommandResult()}}</pre>
							</div>
						</div>
					</div>
					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>

					<br>
                    <md-input type="text" dividerColor="warn" [(ngModel)]="certsDir" placeholder="Kubernetes certs directory"></md-input>
					<br>
					<div class="osx-window">
						<div class="window-narrow">
							<div class="titlebar">
								<div class="buttons">
									<div class="closebtn"><span><strong></strong></span></div>
									<div class="minimize"><span><strong></strong></span></div>
									<div class="zoom"><span><strong></strong></span></div>
								</div><span class="title-bar-text">terminal</span></div>
							<div class="content">
								<pre class="osx-terminal-contents">{{cfssl.getCertsPrepareCommand(certsDir)}}</pre>
							</div>
						</div>
					</div>
					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>
					<br>
				</template>
            </md-tab>


            <md-tab>
                <template md-tab-label>
					Install
				</template>
                <template md-tab-content>
					<br>

					<!--<p class="narrow-paragraph">
						Since CoreOS Linux already comes with <a href="https://coreos.com/kubernetes/docs/latest/kubelet-wrapper.html" target="_blank" class="normal-link">Kubernetes wrapper</a>, only <span class="code-light-snippet">kubectl</span> needs to be installed.
					</p>
					<br>-->

					<p class="narrow-paragraph">
						To install <a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" class="normal-link">Kubernetes binaries</a>
					</p>
					<md-input type="text" [(ngModel)]="kubeInstall.version" placeholder="Kubernetes version"></md-input>
					<md-input type="text" [(ngModel)]="kubeInstall.goOS" placeholder="GOOS"></md-input>
					<md-input type="text" [(ngModel)]="kubeInstall.goARCH" placeholder="GOARCH"></md-input>
					<md-input type="text" [(ngModel)]="kubeInstall.execDir" placeholder="exec dir"></md-input>
					<br>

					<div class="osx-window">
						<div class="window">
							<div class="titlebar">
								<div class="buttons">
									<div class="closebtn"><span><strong></strong></span></div>
									<div class="minimize"><span><strong></strong></span></div>
									<div class="zoom"><span><strong></strong></span></div>
								</div><span class="title-bar-text">terminal</span></div>
							<div class="content">
								<pre class="osx-terminal-contents">{{kubeInstall.getCommand()}}</pre>
							</div>
						</div>
					</div>
					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>
				</template>
            </md-tab>


            <md-tab>
                <template md-tab-label>
					Master Nodes
				</template>
                <template md-tab-content>
					<br>
					<h5>Why?</h5>
					<p class="narrow-paragraph">
						Master node is a centralized control plane for Kubernetes. <a href="http://kubernetes.io/docs/admin/kube-apiserver/" target="_blank" class="code-light-snippet">kube-apiserver</a> provides REST APIs for validating and configuring objects in Kubernetes, storing the cluster states in etcd. <a href="http://kubernetes.io/docs/admin/kube-scheduler/" target="_blank" class="code-light-snippet">kube-scheduler</a> takes various resource requirements and policy constraints and schedules container applications in distributed environments. <a href="http://kubernetes.io/docs/admin/kube-controller-manager/" target="_blank" class="code-light-snippet">kube-controller-manager</a> is a control loop that manages the state of the system. <span class="code-light-snippet">kube-scheduler</span> and <span class="code-light-snippet">kube-controller-manager</span> are tightly coupled with <span class="code-light-snippet">kube-apiserver</span>.
					</p>
					<p class="narrow-paragraph">
					 	Running multiple master nodes is recommended for higher availability. Noe that even all master nodes being unavailable, workers keep operating with the last configuration, and update as soon as master node comes back.
					</p>

					<br>
					<md-input
						style="width: 250px;"
						type="number"
						[(ngModel)]="kubeAPIServer.apiserverCount"
						placeholder="kube-apiserver size (up to 3)"
					></md-input>
					<span *ngIf="kubeAPIServer.apiserverCount > 3" class="error-message">This tool only supports up to 3 nodes</span>
					<br>
					<div *ngFor="let flag of kubeAPIServer.flags; let i = index;">
						<div *ngIf="kubeAPIServer.apiserverCount > i">
							<br>
							<md-input type="text" [(ngModel)]="flag.ipAddress" placeholder="Master Node IP address {{i+1}}"></md-input>
							<md-input type="number" [(ngModel)]="flag.port" placeholder="port"></md-input>
						</div>
					</div>
					<br>

					<br>
					<br>
					<h5>Set up TLS Assets</h5>
					<pre class="code-dark">{{cfssl.getGenCertCommand('kube-apiserver', 'kube-apiserver', kubeAPIServer.getAPIServerIPs())}}</pre>
					<br>
					<p class="narrow-paragraph">
						And copy these certs to master nodes:
					</p>
                    <md-input type="text" dividerColor="warn" [(ngModel)]="certsDir" placeholder="Kubernetes certs directory"></md-input>
					<br>
					<div class="osx-window">
						<div class="window-narrow">
							<div class="titlebar">
								<div class="buttons">
									<div class="closebtn"><span><strong></strong></span></div>
									<div class="minimize"><span><strong></strong></span></div>
									<div class="zoom"><span><strong></strong></span></div>
								</div><span class="title-bar-text">terminal</span></div>
							<div class="content">
								<pre class="osx-terminal-contents">{{cfssl.getCertsPrepareCommand(certsDir)}}</pre>
							</div>
						</div>
					</div>

					<div class="osx-window">
						<div class="window-narrow">
							<div class="titlebar">
								<div class="buttons">
									<div class="closebtn"><span><strong></strong></span></div>
									<div class="minimize"><span><strong></strong></span></div>
									<div class="zoom"><span><strong></strong></span></div>
								</div><span class="title-bar-text">terminal</span></div>
							<div class="content">
								<pre class="osx-terminal-contents">{{cfssl.getCFSSLFilesTxt(certsDir, 'kube-apiserver')}}</pre>
							</div>
						</div>
					</div>
					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>

					<br>
					<h5>Master Node</h5>
					<p class="narrow-paragraph">
						<a href="http://kubernetes.io/docs/admin/kubelet/" target="_blank" class="code-light-snippet">kubelet</a> runs on master nodes with <span class="code-light-snippet">--register-schedulable=false</span> flag. It only communicates with <span class="code-light-snippet">kube-apiserver</span> and routes cluster works to task-specific workder nodes. <a href="http://kubernetes.io/docs/admin/kube-proxy/" target="_blank" class="code-light-snippet">kube-proxy</a> is a network proxy that runs on each node, and must be configured with <span class="code-light-snippet">kube-apiserver</span>.
					</p>
					<br>
					<md-input type="text" [(ngModel)]="kubeAPIServer.version" placeholder="coreos/hyperkube version"></md-input>
					<md-input type="text" [(ngModel)]="kubeAPIServer.serviceClusterIPRange" placeholder="service cluster IP range"></md-input>
					<br>
					<div *ngFor="let flag of kubeAPIServer.flags; let i = index;">
						<div *ngIf="kubeAPIServer.apiserverCount > i">
							<pre class="code-dark">{{kubeAPIServer.getManifest(certsDir, flag)}}
</pre>
						<br>
						</div>
					</div>


					<br>
					<h5>TODO</h5>
					<p class="narrow-paragraph">
						...
					</p>


					<br>
					<h5>TODO</h5>
					<p class="narrow-paragraph">
						...
					</p>

					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>
					<br>
				</template>
            </md-tab>


            <md-tab>
                <template md-tab-label>
					Workers
				</template>
                <template md-tab-content>
					<br>
					<h5>Why?</h5>
					<p class="narrow-paragraph">
						...
					</p>

					<br>
					<h5>TODO</h5>
					<p class="narrow-paragraph">
						...
					</p>

					<br>
					<h5>TODO</h5>
					<p class="narrow-paragraph">
						...
					</p>

					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>
					<br>
				</template>
            </md-tab>


            <md-tab>
                <template md-tab-label>
					kubectl
				</template>
                <template md-tab-content>
					<br>
					<h5>Why?</h5>
					<p class="narrow-paragraph">
						<a href="http://kubernetes.io/docs/user-guide/kubectl-overview/" target="_blank" class="code-light-snippet">kubectl</a> is a command-line program for interacting with Kubernetes.
					</p>

					<br>
					<h5>Set up TLS Assets</h5>
					<br>
					<pre class="code-dark">{{cfssl.getGenCertCommand('kubectl', 'kubectl', kubeAPIServer.getAPIServerIPs())}}</pre>

					<br>
					<p class="narrow-paragraph">
						And copy these certs to <span class="code-light-snippet">kubectl</span> nodes:
					</p>
                    <md-input type="text" dividerColor="warn" [(ngModel)]="certsDir" placeholder="Kubernetes certs directory"></md-input>
					<br>
					<div class="osx-window">
						<div class="window-narrow">
							<div class="titlebar">
								<div class="buttons">
									<div class="closebtn"><span><strong></strong></span></div>
									<div class="minimize"><span><strong></strong></span></div>
									<div class="zoom"><span><strong></strong></span></div>
								</div><span class="title-bar-text">terminal</span></div>
							<div class="content">
								<pre class="osx-terminal-contents">{{cfssl.getCertsPrepareCommand(certsDir)}}</pre>
							</div>
						</div>
					</div>

					<div class="osx-window">
						<div class="window-narrow">
							<div class="titlebar">
								<div class="buttons">
									<div class="closebtn"><span><strong></strong></span></div>
									<div class="minimize"><span><strong></strong></span></div>
									<div class="zoom"><span><strong></strong></span></div>
								</div><span class="title-bar-text">terminal</span></div>
							<div class="content">
								<pre class="osx-terminal-contents">{{cfssl.getCFSSLFilesTxt(certsDir, 'kubectl')}}</pre>
							</div>
						</div>
					</div>
					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>

					<br>
					<h5>kubelet</h5>
					<p class="narrow-paragraph">
						<a href="http://kubernetes.io/docs/admin/kubelet/" target="_blank" class="code-light-snippet">kubelet</a> runs on master nodes with <span class="code-light-snippet">--register-schedulable=false</span> flag. It only communicates with <span class="code-light-snippet">kube-apiserver</span> and routes cluster works to task-specific workder nodes.
					</p>

					<br>
					<h5>TODO</h5>
					<p class="narrow-paragraph">
						...
					</p>

					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>
					<br>
				</template>
            </md-tab>


            <md-tab>
                <template md-tab-label>
					kubedns
				</template>
                <template md-tab-content>
					<br>
					<h5>Why?</h5>
					<p class="narrow-paragraph">
						...
					</p>

					<br>
					<h5>TODO</h5>
					<p class="narrow-paragraph">
						...
					</p>

					<br>
					<h5>TODO</h5>
					<p class="narrow-paragraph">
						...
					</p>

					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>
					<br>
				</template>
            </md-tab>


            <md-tab>
                <template md-tab-label>
					Dashboard
				</template>
                <template md-tab-content>
					<br>
					<h5>Why?</h5>
					<p class="narrow-paragraph">
						...
					</p>

					<br>
					<h5>TODO</h5>
					<p class="narrow-paragraph">
						...
					</p>

					<br>
					<h5>TODO</h5>
					<p class="narrow-paragraph">
						...
					</p>

					<div align="right" class="narrow-paragraph"><a href="/doc/{{docVersion}}/kubernetes#top" class="normal-link">↑ top</a></div>
					<br>
					<br>
				</template>
            </md-tab>

        </md-tab-group>

    </div>
</md-sidenav-layout>